---
interface Props {
  code: string;
  lang?: string;
}

const { code, lang = 'bash' } = Astro.props;
const id = `code-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="code-block-wrapper relative group my-4">
  <button
    class="copy-btn absolute top-3 right-3 p-2 rounded-lg bg-surface-300/80 hover:bg-surface-400 text-gray-400 hover:text-white opacity-0 group-hover:opacity-100 transition-all z-10"
    data-code={code}
    data-id={id}
    aria-label="Copy to clipboard"
  >
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
    </svg>
    <svg class="check-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20 6 9 17l-5-5"/>
    </svg>
  </button>
  <pre class="!mt-0"><code class={`language-${lang}`} id={id}>{code}</code></pre>
</div>

<script>
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const code = btn.getAttribute('data-code');
      if (!code) return;

      try {
        await navigator.clipboard.writeText(code);

        // Show check icon
        const copyIcon = btn.querySelector('.copy-icon');
        const checkIcon = btn.querySelector('.check-icon');

        copyIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');

        // Reset after 2 seconds
        setTimeout(() => {
          copyIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  });
</script>

<style>
  .code-block-wrapper pre {
    padding-right: 3rem;
  }

  .copy-btn:active {
    transform: scale(0.95);
  }
</style>
