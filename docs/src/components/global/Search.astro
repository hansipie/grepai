---
// Pagefind Search Component
const basePath = import.meta.env.BASE_URL || '/grepai/';
---

<div class="search-container">
  <button
    id="search-button"
    type="button"
    class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-400 bg-surface-100 border border-glass-border rounded-lg hover:bg-surface-200 hover:text-gray-300 transition-colors"
    aria-label="Search documentation"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.3-4.3"/>
    </svg>
    <span class="hidden sm:inline">Search...</span>
    <kbd class="hidden md:inline-flex items-center gap-1 px-1.5 py-0.5 text-xs bg-surface-200 rounded border border-glass-border">
      <span class="text-[10px]">âŒ˜</span>K
    </kbd>
  </button>
</div>

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-[100] hidden">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Modal -->
  <div class="relative flex items-start justify-center pt-[10vh] px-4">
    <div class="w-full max-w-2xl bg-surface-50 border border-glass-border rounded-xl shadow-2xl overflow-hidden">
      <!-- Close button -->
      <div class="flex justify-end p-2 border-b border-glass-border">
        <button id="search-close" class="p-1 text-gray-500 hover:text-gray-300 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
          </svg>
        </button>
      </div>
      <div id="pagefind-container"></div>
    </div>
  </div>
</div>

<link rel="stylesheet" href={`${basePath}pagefind/pagefind-ui.css`} />

<style is:global>
  /* Pagefind UI Customization */
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #818cf8;
    --pagefind-ui-text: #cdd6f4;
    --pagefind-ui-background: #1e1e28;
    --pagefind-ui-border: rgba(255, 255, 255, 0.08);
    --pagefind-ui-tag: #24242f;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: 'Inter', system-ui, sans-serif;
  }

  .pagefind-ui {
    padding: 0 !important;
  }

  .pagefind-ui__form {
    padding: 1rem !important;
    border-bottom: 1px solid var(--pagefind-ui-border) !important;
  }

  .pagefind-ui__search-input {
    background: #24242f !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #f5f5f5 !important;
    font-size: 1rem !important;
    padding: 0.75rem 1rem !important;
    border-radius: 8px !important;
  }

  .pagefind-ui__search-input:focus {
    border-color: #818cf8 !important;
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.2) !important;
    outline: none !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: #6c7086 !important;
  }

  .pagefind-ui__search-clear {
    background: transparent !important;
    color: #6c7086 !important;
  }

  .pagefind-ui__search-clear:hover {
    color: #cdd6f4 !important;
  }

  .pagefind-ui__results-area {
    max-height: 60vh !important;
    overflow-y: auto !important;
    padding: 0 !important;
  }

  .pagefind-ui__results {
    padding: 0.5rem !important;
  }

  .pagefind-ui__result {
    padding: 1rem !important;
    border-radius: 8px !important;
    border: none !important;
    margin: 0.25rem 0 !important;
  }

  .pagefind-ui__result:hover {
    background: rgba(255, 255, 255, 0.05) !important;
  }

  .pagefind-ui__result-link {
    color: #f5f5f5 !important;
    font-weight: 500 !important;
  }

  .pagefind-ui__result-link:hover {
    color: #818cf8 !important;
  }

  .pagefind-ui__result-title {
    font-weight: 600 !important;
  }

  .pagefind-ui__result-excerpt {
    color: #a6adc8 !important;
    font-size: 0.875rem !important;
  }

  .pagefind-ui__result-nested {
    padding-left: 1rem !important;
    border-left: 2px solid rgba(129, 140, 248, 0.3) !important;
  }

  .pagefind-ui__message {
    color: #6c7086 !important;
    padding: 2rem !important;
    text-align: center !important;
  }

  mark.pagefind-ui__result-highlight {
    background: rgba(129, 140, 248, 0.3) !important;
    color: inherit !important;
    border-radius: 2px !important;
    padding: 0.1em 0.2em !important;
  }

  .pagefind-ui__button {
    background: #818cf8 !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
    padding: 0.5rem 1rem !important;
  }

  .pagefind-ui__button:hover {
    background: #6366f1 !important;
  }
</style>

<script define:vars={{ basePath }}>
  // Load Pagefind UI script dynamically
  let pagefindLoaded = false;
  let pagefindInitialized = false;

  async function loadPagefind() {
    if (pagefindLoaded) return;

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = `${basePath}pagefind/pagefind-ui.js`;
      script.onload = () => {
        pagefindLoaded = true;
        resolve(true);
      };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initPagefind() {
    const container = document.getElementById('pagefind-container');
    if (!container) return;

    try {
      await loadPagefind();

      // @ts-ignore
      new PagefindUI({
        element: container,
        showSubResults: true,
        showImages: false,
        baseUrl: basePath,
        translations: {
          placeholder: 'Search documentation...',
          zero_results: 'No results for "[SEARCH_TERM]"',
          many_results: '[COUNT] results',
          one_result: '1 result',
          searching: 'Searching...',
        },
      });

      pagefindInitialized = true;

      // Focus input after a small delay
      setTimeout(() => {
        const input = container.querySelector('.pagefind-ui__search-input');
        if (input) {
          input.focus();
        }
      }, 100);
    } catch (error) {
      console.error('Failed to load Pagefind:', error);
      container.innerHTML = '<p style="padding: 2rem; text-align: center; color: #6c7086;">Search unavailable. Build the site first.</p>';
    }
  }

  // Modal controls
  const searchButton = document.getElementById('search-button');
  const searchModal = document.getElementById('search-modal');
  const searchBackdrop = document.getElementById('search-backdrop');
  const searchClose = document.getElementById('search-close');

  function openSearch() {
    if (!searchModal) return;
    searchModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    if (!pagefindInitialized) {
      initPagefind();
    } else {
      // Focus existing input
      setTimeout(() => {
        const input = document.querySelector('.pagefind-ui__search-input');
        if (input) {
          input.focus();
          input.select();
        }
      }, 50);
    }
  }

  function closeSearch() {
    if (!searchModal) return;
    searchModal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Event listeners
  searchButton?.addEventListener('click', openSearch);
  searchBackdrop?.addEventListener('click', closeSearch);
  searchClose?.addEventListener('click', closeSearch);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Cmd/Ctrl + K to open
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    // Escape to close
    if (e.key === 'Escape') {
      closeSearch();
    }
  });
</script>
